<asset-sg-tabs>
  <asset-sg-tab (click)="setFileType({ isLegal: false })" translate>edit.tabs.files.Normal.many</asset-sg-tab>
  <asset-sg-tab (click)="setFileType({ isLegal: true })" translate>edit.tabs.files.Legal.many</asset-sg-tab>

  <ng-container slot="content">
    <div class="content">
      <asset-sg-file-drop-zone [form]="form" [isLegal]="isLegal$ | async"></asset-sg-file-drop-zone>
      @if (dataSource.data.length > 0 || searchTerm$.value) {
        <div>
          <div class="actions">
            <button asset-sg-secondary [disabled]="!hasSelectedFiles" (click)="markSelectedFilesForDeletion()">
              <svg-icon key="delete" />
              <span translate>delete</span>
            </button>
            <button asset-sg-secondary [disabled]="!hasSelectedFiles" (click)="downloadSelectedFiles()">
              <svg-icon key="export" />
              <span translate>edit.tabs.files.export</span>
            </button>
            <span></span>
            <asset-sg-text-input
              (valueChange)="setSearchTerm($event)"
              icon="search"
              small
              [placeholder]="'search.textSearchFieldPlaceholder' | translate"
            />
          </div>
          <table
            mat-table
            [dataSource]="dataSource"
            class="mat-elevation-z8 table"
            matSort
            (matSortChange)="sortChange($event)"
          >
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef class="column-pick">
                <span translate>
                  <mat-checkbox [checked]="areAllFilesSelected" (change)="toggleAll($event)" color="primary" />
                </span>
              </th>
              <td mat-cell *matCellDef="let control" class="column-pick">
                @if (!activeFileDownloads.has(control.value.id)) {
                  <mat-checkbox
                    [checked]="isSelected(control.value)"
                    (change)="selectFile(control, $event)"
                    color="primary"
                  />
                } @else {
                  <div class="download-wrapper">
                    <mat-progress-spinner mode="indeterminate" [diameter]="18" />
                  </div>
                }
              </td>
            </ng-container>
            <ng-container matColumnDef="name">
              <th mat-header-cell mat-sort-header="name" *matHeaderCellDef class="column-name">
                <span translate>admin.name</span>
              </th>
              <td mat-cell *matCellDef="let control" class="column-name">
                <span
                  [matTooltip]="
                    control.value.file
                      ? control.value.file.name
                      : ('edit.tabs.files.fileNameTooltip'
                        | translate
                          : { name: control.value.name, date: control.value.lastModifiedAt | date: 'dd.MM.yyyy HH:mm' })
                  "
                  matTooltipPosition="above"
                  [class.will-be-deleted]="control.value.shouldBeDeleted"
                  >{{ control.value.file?.name ?? control.value.name }}</span
                >
              </td>
            </ng-container>
            <ng-container matColumnDef="legalDocCode">
              <th mat-header-cell *matHeaderCellDef translate>edit.tabs.general.type</th>
              <td mat-cell *matCellDef="let control">
                <asset-sg-select
                  [initialKeys]="control.value.legalDocCode"
                  [values]="legalDocItems$ | push"
                  bindLabel="name"
                  bindKey="code"
                  (selectionChanged)="updateLegalDocItemCode(control, $event)"
                  small
                >
                </asset-sg-select>
              </td>
            </ng-container>
            <ng-container matColumnDef="processingState">
              <th mat-header-cell *matHeaderCellDef class="column-ocr-status">
                <span translate>edit.tabs.files.fileProcessingState</span>
              </th>
              <td mat-cell *matCellDef="let control" class="column-ocr-status">
                @if (control.value.fileProcessingState && control.value.fileProcessingStage) {
                  {{ control.value.fileProcessingStage }} ({{
                    "edit.tabs.files.fileProcessingStateValues." + control.value.fileProcessingState | translate
                  }})
                } @else {
                  {{ "edit.tabs.files.fileProcessingStateValues.WillNotBeProcessed" | translate }}
                }
              </td>
            </ng-container>
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="column-actions"></th>
              <td mat-cell *matCellDef="let control; let idx = index" class="column-actions">
                <div>
                  <sgc-button
                    (click)="markFileForDeletion(control.value)"
                    [matTooltip]="'delete' | translate"
                    color="secondary"
                    variant="icon"
                    size="small"
                    justify="center"
                  >
                    <sgc-icon name="trash" />
                  </sgc-button>
                  <sgc-button
                    (click)="downloadFile(control.value)"
                    [isDisabled]="!control.value.id"
                    [matTooltip]="'edit.tabs.files.export' | translate"
                    color="secondary"
                    variant="icon"
                    size="small"
                    justify="center"
                  >
                    <sgc-icon name="download" />
                  </sgc-button>
                  <sgc-button
                    [isDisabled]="
                      !(
                        control?.value?.fileProcessingStage != null &&
                        control.value.fileProcessingStage === FileProcessingStage.Extraction &&
                        (control.value.fileProcessingState === FileProcessingState.Success ||
                          control.value.fileProcessingState === FileProcessingState.Error)
                      )
                    "
                    color="secondary"
                    variant="icon"
                    size="small"
                    justify="center"
                    (click)="openPageRangeEditor(control.value)"
                  >
                    <sgc-icon name="tableOfContents" />
                  </sgc-button>
                </div>
              </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="displayedColumns" class="table__header"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>
      }
    </div>
  </ng-container>
</asset-sg-tabs>
